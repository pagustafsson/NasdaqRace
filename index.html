<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nasdaq 100 Bar Chart Race</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pagustafsson.github.io/NasdaqRace/">
    <meta property="og:title" content="Nasdaq 100 Market Cap Race (30 Years)">
    <meta property="og:description"
        content="A visualization of the Nasdaq 100 market capitalization history over the last 30 years. Vibe Coded by P-A Gustafsson.">
    <meta property="og:image" content="https://pagustafsson.github.io/NasdaqRace/og-image.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://pagustafsson.github.io/NasdaqRace/">
    <meta property="twitter:title" content="Nasdaq 100 Market Cap Race (30 Years)">
    <meta property="twitter:description"
        content="A visualization of the Nasdaq 100 market capitalization history over the last 30 years. Vibe Coded by P-A Gustafsson.">
    <meta property="twitter:image" content="https://pagustafsson.github.io/NasdaqRace/og-image.jpg">

    <link rel="stylesheet" href="styles.css?v=7">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
    <!-- Info Button (Fixed Position) -->
    <button id="info-btn" class="icon-btn" aria-label="Information">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
    </button>

    <div class="container">
        <div class="header-row">
            <h1>Nasdaq 100 Market Cap Race (30 Years)</h1>
        </div>
        <div id="chart-container">
            <div id="ticker-date">Loading...</div>
            <div id="chart"></div>
        </div>
        <div class="controls">
            <button id="play-pause-btn">Play</button>
            <input type="range" id="date-slider" min="0" max="100" value="0">
            <select id="speed-selector">
                <option value="1">1x Speed</option>
                <option value="2">2x Speed</option>
                <option value="5">5x Speed</option>
                <option value="10">10x Speed</option>
            </select>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="close-modal-btn" class="close-btn">Close</button>
            <h2>About the Data</h2>
            <p>
                This visualization displays the historical market capitalization of companies <strong>currently
                    listed</strong> in the Nasdaq 100.
            </p>
            <p>
                Due to limitations in free historical data sources, companies that were delisted, acquired, or went
                bankrupt prior to today (e.g., Sun Microsystems, AOL, Twitter) are <strong>not included</strong>.
            </p>
            <p>
                This results in "survivorship bias"â€”showing the historical rise of today's winners rather than a
                complete historical snapshot of the index at any given time.
            </p>
            <div class="credits">
                <p>Vibe Coded by <strong>P-A Gustafsson</strong></p>
                <div class="social-links">
                    <a href="https://www.linkedin.com/in/pagustafsson/" target="_blank" rel="noopener noreferrer"
                        aria-label="LinkedIn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
                        </svg>
                    </a>
                    <a href="https://x.com/pagustafsson" target="_blank" rel="noopener noreferrer"
                        aria-label="X (Twitter)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Configuration - Responsive dimensions
        function getResponsiveDimensions() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;

            if (viewportWidth <= 480) {
                // Mobile
                return {
                    topN: 8,
                    width: viewportWidth - 20,
                    height: Math.min(viewportHeight * 0.6, 500),
                    margin: { top: 10, right: 60, bottom: 20, left: 80 }
                };
            } else if (viewportWidth <= 768) {
                // Tablet
                return {
                    topN: 10,
                    width: viewportWidth - 40,
                    height: Math.min(viewportHeight * 0.65, 550),
                    margin: { top: 15, right: 80, bottom: 25, left: 100 }
                };
            } else {
                // Desktop
                return {
                    topN: 12,
                    width: Math.min(viewportWidth - 100, 1000),
                    height: 600,
                    margin: { top: 20, right: 100, bottom: 30, left: 150 }
                };
            }
        }

        let dimensions = getResponsiveDimensions();
        let topN = dimensions.topN;
        const baseDuration = 250; // ms per frame at 1x
        let duration = baseDuration;
        let width = dimensions.width;
        let height = dimensions.height;
        let margin = dimensions.margin;

        let svg, x, y, xAxis, yAxis;
        let dateLabel;
        let tickerData = [];
        let dateList = [];
        let currentFrame = 0;
        let intervalId = null;
        let isPlaying = false;

        // Tooltip div
        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Scroll state
        let viewOffset = 0;
        let maxRank = 0;

        async function init() {
            const data = await d3.json("nasdaq_data.json?" + new Date().getTime());

            // Group data by date
            const grouped = d3.group(data, d => d.date);
            dateList = Array.from(grouped.keys()).sort();

            // Pre-process data for each frame
            tickerData = dateList.map(date => {
                let items = grouped.get(date);
                items.sort((a, b) => b.value - a.value);
                // Assign ranks
                items.forEach((d, i) => d.rank = i);
                return {
                    date: date,
                    items: items
                };
            });

            // Determine max rank for scrolling
            maxRank = d3.max(tickerData, d => d.items.length) - 1;

            setupChart();
            update(0);

            // Controls
            const btn = document.getElementById('play-pause-btn');
            const slider = document.getElementById('date-slider');
            const speedSel = document.getElementById('speed-selector');

            slider.max = dateList.length - 1;

            btn.addEventListener('click', () => {
                if (isPlaying) {
                    stopAnimation();
                } else {
                    startAnimation();
                }
            });

            slider.addEventListener('input', (e) => {
                stopAnimation();
                currentFrame = +e.target.value;
                update(currentFrame);
            });

            speedSel.addEventListener('change', (e) => {
                const speed = +e.target.value;
                duration = baseDuration / speed;
                // If playing, restart to apply new speed
                if (isPlaying) {
                    stopAnimation();
                    startAnimation();
                }
            });

            // Modal Logic
            const infoBtn = document.getElementById('info-btn');
            const modal = document.getElementById('info-modal');
            const closeBtn = document.getElementById('close-modal-btn');

            function openModal() {
                modal.classList.add('open');
            }

            function closeModal() {
                modal.classList.remove('open');
            }

            infoBtn.addEventListener('click', openModal);
            closeBtn.addEventListener('click', closeModal);

            // Close on click outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Mouse Wheel Scrolling
            let scrollAccumulator = 0;
            const scrollThreshold = 50; // Higher = slower scroll

            d3.select(window).on("wheel", (e) => {
                // Only prevent default if we are actually scrolling the chart
                // But since body overflow is hidden, we can just prevent default always to avoid bounce
                e.preventDefault();

                scrollAccumulator += e.deltaY;

                if (Math.abs(scrollAccumulator) < scrollThreshold) return;

                const direction = scrollAccumulator > 0 ? 1 : -1;
                scrollAccumulator = 0; // Reset

                let newOffset = viewOffset + direction;

                // Clamp
                const currentTotal = tickerData[currentFrame].items.length;
                const maxOffset = Math.max(0, currentTotal - topN);

                if (newOffset < 0) newOffset = 0;
                if (newOffset > maxOffset) newOffset = maxOffset;

                if (newOffset !== viewOffset) {
                    viewOffset = newOffset;
                    // Update immediately with 0 duration to prevent "sticking" artifacts
                    update(currentFrame, 0);
                }
            });
        }

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const newDimensions = getResponsiveDimensions();

                // Only reload if dimensions actually changed
                if (newDimensions.width !== width || newDimensions.height !== height || newDimensions.topN !== topN) {
                    dimensions = newDimensions;
                    topN = dimensions.topN;
                    width = dimensions.width;
                    height = dimensions.height;
                    margin = dimensions.margin;

                    // Rebuild chart
                    d3.select("#chart").selectAll("*").remove();
                    setupChart();
                    update(currentFrame, 0);
                }
            }, 250);
        });

        function setupChart() {
            svg = d3.select("#chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            x = d3.scaleLinear()
                .range([margin.left, width - margin.right]);

            y = d3.scaleBand()
                .range([margin.top, height - margin.bottom])
                .padding(0.4);

            dateLabel = d3.select("#ticker-date");
        }

        function formatCurrency(value) {
            if (value >= 1e12) return (value / 1e12).toFixed(2) + " T";
            if (value >= 1e9) return (value / 1e9).toFixed(1) + " B";
            return (value / 1e6).toFixed(0) + " M";
        }

        function update(frameIndex, transitionDuration = duration) {
            const frameData = tickerData[frameIndex];

            // Slice data based on viewOffset
            const visibleItems = frameData.items.slice(viewOffset, viewOffset + topN);

            // Update slider and date label
            document.getElementById('date-slider').value = frameIndex;
            dateLabel.text(frameData.date);

            // Update scales
            const maxVal = visibleItems.length > 0 ? visibleItems[0].value : 0;
            x.domain([0, maxVal]);
            y.domain(d3.range(topN));

            // Bind data
            const bars = svg.selectAll(".bar-group")
                .data(visibleItems, d => d.name);

            // ENTER
            const enter = bars.enter()
                .append("g")
                .attr("class", "bar-group")
                .attr("transform", (d, i) => `translate(0, ${y(i)})`)
                .on("mouseover", function (event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);

                    tooltip.html(d.fullname);

                    // Use client coordinates for fixed positioning
                    const x = event.clientX;
                    const y = event.clientY;

                    // Clamp to window bounds to prevent any potential overflow issues
                    // (though fixed position shouldn't trigger scroll, this is safer)
                    const windowWidth = window.innerWidth;
                    const tooltipWidth = 200; // Approx max width

                    let finalX = x;
                    if (x > windowWidth - 100) {
                        finalX = windowWidth - 100;
                    }
                    if (x < 100) {
                        finalX = 100;
                    }

                    tooltip.style("left", finalX + "px")
                        .style("top", y + "px");
                })
                .on("mouseout", function (d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Removed native title

            enter.append("rect")
                .attr("class", "bar")
                .attr("height", y.bandwidth())
                .attr("x", x(0))
                .attr("width", d => x(d.value) - x(0))
                .attr("fill", "#ffffff") // Always white
                .attr("rx", y.bandwidth() / 2)
                .attr("ry", y.bandwidth() / 2);

            // Rank Number (Static column)
            enter.append("text")
                .attr("class", "rank-label")
                .attr("x", margin.left - 120) // Fixed position on left
                .attr("y", y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "start") // Left align
                .style("fill", "#888") // Grey color for rank
                .text(d => d.rank + 1);

            // Company Name
            enter.append("text")
                .attr("class", "label")
                .attr("x", margin.left - 10)
                .attr("y", y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", "end")
                .text(d => d.name);

            enter.append("text")
                .attr("class", "value")
                .attr("x", d => x(d.value) + 10)
                .attr("y", y.bandwidth() / 2)
                .attr("dy", "0.35em")
                .text(d => formatCurrency(d.value));

            // UPDATE
            const updateSelection = bars.merge(enter);

            updateSelection.transition().duration(transitionDuration).ease(d3.easeLinear)
                .attr("transform", (d, i) => `translate(0, ${y(i)})`);

            updateSelection.select(".bar")
                .transition().duration(transitionDuration).ease(d3.easeLinear)
                .attr("width", d => x(d.value) - x(0))
                .attr("fill", "#ffffff");

            updateSelection.select(".rank-label")
                .text(d => d.rank + 1); // Update rank

            updateSelection.select(".label")
                .text(d => d.name);

            // Update tooltip content if hovering during update? 
            // Usually not needed as data is bound to element.

            updateSelection.select(".value")
                .transition().duration(transitionDuration).ease(d3.easeLinear)
                .attr("x", d => x(d.value) + 10)
                .tween("text", function (d) {
                    const currentText = this.textContent;
                    let oldVal = parseFloat(currentText);

                    if (currentText.includes("T")) {
                        oldVal *= 1e12;
                    } else if (currentText.includes("B")) {
                        oldVal *= 1e9;
                    } else if (currentText.includes("M")) {
                        oldVal *= 1e6;
                    } else {
                        // Fallback or 0 if NaN
                        oldVal = oldVal || 0;
                    }

                    const i = d3.interpolateNumber(oldVal, d.value);
                    return function (t) {
                        this.textContent = formatCurrency(i(t));
                    };
                });

            // EXIT
            bars.exit()
                .remove();
        }

        function startAnimation() {
            if (isPlaying) return;
            isPlaying = true;
            document.getElementById('play-pause-btn').textContent = "Pause";

            intervalId = setInterval(() => {
                currentFrame++;
                if (currentFrame >= tickerData.length) {
                    stopAnimation();
                    currentFrame = 0; // Reset or stay at end? Let's stay at end.
                    return;
                }
                update(currentFrame);
            }, duration);
        }

        function stopAnimation() {
            isPlaying = false;
            document.getElementById('play-pause-btn').textContent = "Play";
            clearInterval(intervalId);
        }

        init();
    </script>
</body>

</html>